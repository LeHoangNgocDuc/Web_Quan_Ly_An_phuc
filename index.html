<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng T√†i Li·ªáu An Ph√∫c</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        :root { --primary: #2c3e50; --accent: #d9534f; --light-bg: #f8f9fa; }
        body { background: var(--light-bg); font-family: 'Segoe UI', sans-serif; }
        .navbar-custom { background: #222; padding: 0; }
        .navbar-custom .nav-link { color: #aaa !important; padding: 15px 20px; font-weight: 500; text-transform: uppercase; font-size: 0.9rem; cursor: pointer; }
        .navbar-custom .nav-link.active-tab { color: #fff !important; background: var(--accent); }
        .navbar-brand img { height: 40px; margin-right: 10px; border-radius: 5px; } 
        .grade-btn { border: 1px solid #ddd; background: white; color: #555; border-radius: 20px; padding: 8px 20px; margin-right: 8px; font-weight: 500; white-space: nowrap; margin-bottom: 10px; }
        .grade-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .grade-btn.special-access { border-color: #ffc107; background-color: #fff3cd; color: #856404; }
        .item-card { background: #fff; border: 1px solid #e9ecef; padding: 15px; margin-bottom: 15px; border-radius: 8px; transition: 0.2s; display: flex; flex-direction: column; }
        .sub-btn { font-size: 0.9rem; padding: 5px 15px; border-radius: 5px; border: 1px dashed #aaa; color: #666; background: transparent; margin-right: 5px; margin-bottom: 5px; }
        .sub-btn.active { background: var(--accent); color: white; border-style: solid; border-color: var(--accent); }
        #adminArea { display: none; background: #fff; border: 2px dashed #333; border-radius: 10px; padding: 20px; margin-bottom: 30px; }
        #loader { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; text-align:center; padding-top:20%; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loader"><div class="spinner"></div><p class="mt-2 fw-bold text-secondary">ƒêang k·∫øt n·ªëi...</p></div>

    <nav class="navbar navbar-expand-lg navbar-custom">
        <div class="container">
            <a class="navbar-brand text-white d-flex align-items-center" href="#">
                <img id="appLogo" src="" alt="Logo" onerror="this.style.display='none'"> 
                <span id="appName">AN PH√öC EDU</span>
            </a>
            <button class="navbar-toggler bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link active-tab" onclick="switchMainTab('hoclieu')" id="tab-hoclieu">H·ªåC LI·ªÜU</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="switchMainTab('elearning')" id="tab-elearning">ELEARNING</a></li>
                    <li class="nav-item"><a class="nav-link" href="https://web-dung-hinh.vercel.app/" target="_blank">WEB V·∫º H√åNH</a></li>
                    <li class="nav-item"><a class="nav-link" href="https://trung-tam-an-phuc.vercel.app/" target="_blank">KI·ªÇM TRA ONLINE</a></li>
                </ul>
                <div class="d-flex align-items-center">
                    <button class="btn btn-outline-light btn-sm" onclick="modalLogin.show()" id="btnAuth">ƒêƒÇNG NH·∫¨P</button>
                    <div id="userMenu" class="dropdown ms-2" style="display:none;">
                        <button class="btn btn-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" id="userDisplayName">User</button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" onclick="modalChangePass.show()">üîë ƒê·ªïi m·∫≠t kh·∫©u</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="doLogout()">ƒêƒÉng xu·∫•t</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4 mb-5">
        <div id="adminArea">
            <h5 class="text-danger fw-bold"><i class="bi bi-shield-lock-fill"></i> QU·∫¢N TR·ªä VI√äN</h5>
            <ul class="nav nav-pills mb-3">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-file">Upload T√†i Li·ªáu</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-video">ƒêƒÉng Video</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-approve" onclick="loadPendingUsers()">Duy·ªát th√†nh vi√™n <span class="badge bg-danger" id="badgePending"></span></button></li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane fade show active" id="pills-file">
                    <div class="card p-3 bg-light border-0">
                        <div class="row g-2 mb-3">
                            <div class="col-md-6"><label class="fw-bold small">1. Ch·ªçn Kh·ªëi L·ªõp:</label><select id="upGrade" class="form-select"></select></div>
                            <div class="col-md-6"><label class="fw-bold small">2. Ch·ªçn H·ªçc k·ª≥/M·ª•c:</label><select id="upCat" class="form-select"></select></div>
                        </div>
                        <div class="d-flex gap-3 mb-3">
                            <div class="form-check"><input class="form-check-input" type="radio" name="uploadMode" id="modeFile" checked onchange="toggleUploadMode()"><label class="form-check-label" for="modeFile">Upload File PDF</label></div>
                            <div class="form-check"><input class="form-check-input" type="radio" name="uploadMode" id="modeLink" onchange="toggleUploadMode()"><label class="form-check-label" for="modeLink">Nh·∫≠p Link (File n·∫∑ng)</label></div>
                        </div>
                        <div id="areaFile">
                            <input type="file" id="fileInput" class="form-control mb-2" accept=".pdf,.doc,.docx">
                            <button class="btn btn-danger" onclick="doUploadFile()">Upload File</button>
                        </div>
                        <div id="areaLink" style="display:none;">
                            <input type="text" id="linkName" class="form-control mb-2" placeholder="T√™n t√†i li·ªáu">
                            <input type="text" id="linkUrl" class="form-control mb-2" placeholder="Link Drive/Web">
                            <button class="btn btn-primary" onclick="doSaveLink()">L∆∞u Link</button>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="pills-video">
                    <div class="row g-2">
                        <div class="col-md-3"><select id="vidGrade" class="form-select"></select></div>
                        <div class="col-md-3"><select id="vidCat" class="form-select"><option>ƒê·∫°i s·ªë</option><option>H√¨nh h·ªçc</option></select></div>
                        <div class="col-md-6"><input type="text" id="vidTitle" class="form-control" placeholder="Ti√™u ƒë·ªÅ"></div>
                        <div class="col-md-12 mt-2"><input type="text" id="vidUrl" class="form-control" placeholder="Link Youtube"></div>
                        <div class="col-md-12 mt-2 text-end"><button class="btn btn-danger" onclick="doSaveVideo()">ƒêƒÉng Video</button></div>
                    </div>
                </div>
                <div class="tab-pane fade" id="pills-approve">
                    <div class="card p-3 mb-3 bg-light border-primary">
                        <h6 class="text-primary fw-bold">Th√™m nhanh h·ªçc sinh</h6>
                        <div class="row align-items-center g-2">
                            <div class="col-md-6"><input type="file" id="csvFileInput" class="form-control form-control-sm" accept=".csv"></div>
                            <div class="col-md-4"><button class="btn btn-primary btn-sm w-100" onclick="handleBulkImport()">Upload & Duy·ªát</button></div>
                        </div>
                    </div>
                    <table class="table table-bordered table-hover bg-white"><tbody id="pendingTable"><tr><td class="text-center">ƒêang t·∫£i...</td></tr></tbody></table>
                </div>
            </div>
        </div>

        <div class="mb-4">
            <h5 class="fw-bold text-dark mb-3" id="sectionTitle"><i class="bi bi-folder2-open text-danger"></i> KHO T√ÄI LI·ªÜU</h5>
            <div class="d-flex" style="overflow-x:auto; padding-bottom:10px;" id="gradeFilters"></div>
            <div class="d-flex flex-wrap" id="subFilters" style="display:none; gap:10px; margin-bottom:15px;"></div>
            <input type="text" class="form-control mt-2" placeholder="üîç T√¨m ki·∫øm..." onkeyup="textSearch(this.value)">
        </div>
        <div id="listContainer" class="row"><div class="text-center py-5 text-muted">ƒêang t·∫£i d·ªØ li·ªáu...</div></div>
    </div>

    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white"><h5 class="modal-title">ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3"><li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-login">ƒêƒÉng nh·∫≠p</button></li><li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-register">ƒêƒÉng k√Ω</button></li></ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="tab-login">
                            <select id="logGrade" class="form-select mb-2" onchange="loadLogClasses()"><option value="">-- Ch·ªçn Kh·ªëi --</option></select>
                            <select id="logClass" class="form-select mb-2" onchange="loadLogNames()"><option value="">-- Ch·ªçn L·ªõp --</option></select>
                            <select id="logName" class="form-select mb-2"><option value="">-- Ch·ªçn T√™n --</option></select>
                            <input type="password" id="logPass" class="form-control mb-3" placeholder="M·∫≠t kh·∫©u">
                            <hr><div class="input-group mb-3"><span class="input-group-text">Admin</span><input type="text" id="adminUser" class="form-control" placeholder="User"><input type="password" id="adminPass" class="form-control" placeholder="Pass"></div>
                            <button class="btn btn-success w-100" onclick="doLogin()">ƒêƒÉng nh·∫≠p</button>
                        </div>
                        <div class="tab-pane fade" id="tab-register">
                             <select id="regGrade" class="form-select mb-2" onchange="loadRegClasses()"></select>
                             <select id="regClass" class="form-select mb-2"></select>
                             <input type="text" id="regName" class="form-control mb-2" placeholder="H·ªç t√™n ƒë·∫ßy ƒë·ªß">
                             <input type="password" id="regPass" class="form-control mb-3" placeholder="M·∫≠t kh·∫©u t·ª± t·∫°o">
                             <button class="btn btn-primary w-100" onclick="doRegister()">G·ª≠i ƒëƒÉng k√Ω</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="changePassModal" tabindex="-1"><div class="modal-dialog modal-sm"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">ƒê·ªïi m·∫≠t kh·∫©u</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="password" id="oldP" class="form-control mb-2" placeholder="M·∫≠t kh·∫©u c≈©"><input type="password" id="newP" class="form-control" placeholder="M·∫≠t kh·∫©u m·ªõi"></div><div class="modal-footer"><button class="btn btn-primary w-100" onclick="doChangePass()">L∆∞u</button></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ===========================================
        // D√ÅN URL M·ªöI SAU KHI DEPLOY V√ÄO ƒê√ÇY:
        const API_URL = "https://script.google.com/macros/s/AKfycbxT6S52eLkO986FQDj9JOw6VKVvlhn826fUMHwcwreJBX0YIjyU9ZN6owLPq02cv4lhgA/exec"; 
        const LOGO_URL = "https://raw.githubusercontent.com/lehoangngocduc/Hoc-Toan-An-Phuc/main/logo.png"; 
        // ===========================================

        const GRADE_CONFIG = [{id:"6",name:"L·ªõp 6"},{id:"7",name:"L·ªõp 7"},{id:"8",name:"L·ªõp 8"},{id:"9",name:"L·ªõp 9"},{id:"ts10",name:"TS10"},{id:"10",name:"L·ªõp 10"},{id:"11",name:"L·ªõp 11"},{id:"12",name:"L·ªõp 12"},{id:"thptqg",name:"THPTQG"}];
        const SUB_CATS = { hoclieu:{default:["HKI","HKII","L√Ω thuy·∫øt"],special:["Chuy√™n ƒë·ªÅ"]}, elearning:{default:["ƒê·∫°i s·ªë","H√¨nh h·ªçc"],special:["ƒê·∫°i s·ªë","H√¨nh h·ªçc"]} };
        let appData = {files:[],videos:[],classes:{},users:{}}, currentMode = 'hoclieu', currentFilter = {grade:'all',category:'all'}, currentUser = null;
        const modalLogin = new bootstrap.Modal(document.getElementById('loginModal')), modalChangePass = new bootstrap.Modal(document.getElementById('changePassModal'));

        window.onload = function(){ 
            if(LOGO_URL) { document.getElementById('appLogo').src = LOGO_URL; document.getElementById('appLogo').style.display='block'; }
            if(!API_URL.includes("script.google.com")){ alert("C·∫£nh b√°o: Ch∆∞a c·∫≠p nh·∫≠t Link API!"); return; }
            initFilters(); fetchData(); 
        };

        async function callAPI(payload) {
            try {
                const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
                return await res.json();
            } catch (error) { console.error("API Error:", error); return { status: "error", message: "L·ªói k·∫øt n·ªëi Server! Vui l√≤ng th·ª≠ l·∫°i." }; }
        }
        
        async function fetchData() {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                if(data.error) { alert("L·ªói Server: " + data.error); return; }
                appData = data;
                applyFilter(); initLogDropdowns(); initRegDropdowns(); initAdminDropdowns();
            } catch (e) { console.error(e); }
        }

        // --- IMPORT CSV FIX ENCODING ---
        function handleBulkImport() {
            const f = document.getElementById('csvFileInput').files[0];
            if(!f) return alert("Ch∆∞a ch·ªçn file CSV!");
            
            // TH·ª¨ ƒê·ªåC V·ªöI M√É TI·∫æNG VI·ªÜT/WINDOWS
            let r = new FileReader();
            r.onload = async function(e) {
                toggleLoader(true);
                const res = await callAPI({ action: "importUsersBulk", csvContent: e.target.result });
                toggleLoader(false);
                if(res.status === "success") { alert("ƒê√£ th√™m " + res.count + " HS!"); fetchData(); } else alert("L·ªói: " + res.message);
            };
            // Quan tr·ªçng: ƒê·ªçc d∆∞·ªõi d·∫°ng utf-8 ƒë·ªÉ t∆∞∆°ng th√≠ch
            r.readAsText(f, "UTF-8"); 
        }

        // C√ÅC H√ÄM LOGIC C√íN L·∫†I (GI·ªÆ NGUY√äN)
        function initLogDropdowns(){if(!appData.users)return;let gs=Object.keys(appData.users).sort((a,b)=>a-b);let h='<option value="">-- Ch·ªçn Kh·ªëi --</option>';gs.forEach(g=>h+=`<option value="${g}">Kh·ªëi ${g}</option>`);document.getElementById('logGrade').innerHTML=h;}
        function loadLogClasses(){let g=document.getElementById('logGrade').value;let h='<option value="">-- Ch·ªçn L·ªõp --</option>';if(g&&appData.users[g])Object.keys(appData.users[g]).sort().forEach(c=>h+=`<option value="${c}">${c}</option>`);document.getElementById('logClass').innerHTML=h;document.getElementById('logName').innerHTML='<option value="">-- Ch·ªçn T√™n --</option>';}
        function loadLogNames(){let g=document.getElementById('logGrade').value,c=document.getElementById('logClass').value;let h='<option value="">-- Ch·ªçn T√™n --</option>';if(g&&c&&appData.users[g][c])appData.users[g][c].forEach(n=>h+=`<option value="${n}">${n}</option>`);document.getElementById('logName').innerHTML=h;}
        function toggleUploadMode() { let isFile = document.getElementById('modeFile').checked; document.getElementById('areaFile').style.display = isFile ? 'block' : 'none'; document.getElementById('areaLink').style.display = isFile ? 'none' : 'block'; }
        function doUploadFile() { let f = document.getElementById('fileInput').files[0]; if(!f) return alert("Ch∆∞a ch·ªçn file"); toggleLoader(true); let r = new FileReader(); r.readAsDataURL(f); r.onload = async function() { const res = await callAPI({ action: "upload", fileName: f.name, mimeType: f.type, fileData: r.result.split(',')[1], grade: document.getElementById('upGrade').value, category: document.getElementById('upCat').value }); toggleLoader(false); if(res.status === "success") { alert("Upload th√†nh c√¥ng!"); fetchData(); } else alert("L·ªói: " + res.message); }; }
        async function doSaveLink() { let n = document.getElementById('linkName').value, u = document.getElementById('linkUrl').value; if(!n || !u) return alert("Nh·∫≠p ƒë·ªß th√¥ng tin!"); toggleLoader(true); const res = await callAPI({ action: "saveFileLink", fileName: n, url: u, grade: document.getElementById('upGrade').value, category: document.getElementById('upCat').value }); toggleLoader(false); if(res.status === "success") { alert("L∆∞u link th√†nh c√¥ng!"); fetchData(); } else alert("L·ªói: " + res.message); }
        async function doLogin(){let u=document.getElementById('adminUser').value,p=document.getElementById('adminPass').value;if(u||p){toggleLoader(true);const r=await callAPI({action:"login",username:u,pass:p});toggleLoader(false);if(r.status=="success"&&r.role=="admin"){currentUser=r;onLoginSuccess();}else alert("Sai Admin!");}else{let n=document.getElementById('logName').value,lp=document.getElementById('logPass').value;if(!n||!lp)return alert("Thi·∫øu th√¥ng tin");toggleLoader(true);const r=await callAPI({action:"login",username:n,pass:lp});toggleLoader(false);if(r.status=="success"){currentUser=r;onLoginSuccess();}else alert(r.message);}}
        function switchMainTab(m){currentMode=m;currentFilter={grade:'all',category:'all'};document.querySelectorAll('.navbar-custom .nav-link').forEach(l=>l.classList.remove('active-tab'));document.getElementById('tab-'+m).classList.add('active-tab');initFilters();applyFilter();}
        function initFilters(){const c=document.getElementById('gradeFilters');let h=`<button class="grade-btn active" onclick="filterGrade('all',this)">T·∫•t c·∫£</button>`;GRADE_CONFIG.forEach(g=>{let e="";if(currentUser&&currentUser.grade=="9"&&g.id=="ts10")e="special-access";if(currentUser&&currentUser.grade=="12"&&g.id=="thptqg")e="special-access";h+=`<button class="grade-btn ${e}" onclick="filterGrade('${g.id}',this)">${g.name}</button>`});c.innerHTML=h;}
        function filterGrade(g,b){document.querySelectorAll('.grade-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');currentFilter.grade=g;currentFilter.category='all';const s=document.getElementById('subFilters');if(g==='all')s.style.display='none';else{s.style.display='flex';let k=(g=='ts10'||g=='thptqg')?SUB_CATS[currentMode].special:SUB_CATS[currentMode].default;let h=`<button class="sub-btn active" onclick="filterSub('all',this)">T·∫•t c·∫£</button>`;k.forEach(x=>{h+=`<button class="sub-btn" onclick="filterSub('${x}',this)">${x}</button>`});s.innerHTML=h;}applyFilter();}
        function filterSub(c,b){document.querySelectorAll('.sub-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');currentFilter.category=c;applyFilter();}
        function applyFilter(){const c=document.getElementById('listContainer');let s=currentMode==='hoclieu'?appData.files:appData.videos;let r=s.filter(i=>{let mg=currentFilter.grade==='all'||i.grade==currentFilter.grade;let mc=currentFilter.category==='all'||i.category==currentFilter.category;return mg&&mc;});if(r.length===0){c.innerHTML='<div class="col-12 text-center text-muted py-5">Ch∆∞a c√≥ n·ªôi dung.</div>';return;}let h='';r.forEach(i=>{let gn=GRADE_CONFIG.find(g=>g.id==i.grade)?.name||"Chung";if(i.type==='file'){let linkMode = i.source==='link' ? 'üîó Link' : '‚¨á T·∫£i v·ªÅ'; h+=`<div class="col-md-6 col-lg-4"><div class="item-card flex-row align-items-center"><i class="bi bi-file-earmark-pdf-fill text-danger fs-1 me-3"></i><div><h6 class="fw-bold mb-1">${i.name}</h6><small class="text-muted d-block">${gn} - <span class="badge bg-secondary">${i.category}</span></small><a href="${i.url}" target="_blank" class="btn btn-sm btn-outline-primary mt-2">${linkMode}</a></div></div></div>`;}else{let vid=i.url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/)?.[2]||"";let t=`https://img.youtube.com/vi/${vid}/mqdefault.jpg`;h+=`<div class="col-md-6 col-lg-4"><div class="item-card"><a href="${i.url}" target="_blank" class="position-relative"><img src="${t}" style="width:100%;height:160px;object-fit:cover;border-radius:6px;"><div class="position-absolute top-50 start-50 translate-middle"><i class="bi bi-play-circle-fill text-danger fs-1 bg-white rounded-circle"></i></div></a><h6 class="fw-bold text-truncate mt-2">${i.name}</h6><div class="d-flex justify-content-between align-items-center"><small class="badge bg-success">${i.category}</small><small class="text-muted">${gn}</small></div></div></div>`;}});c.innerHTML=h;}
        function onLoginSuccess(){modalLogin.hide();document.getElementById('btnAuth').style.display='none';document.getElementById('userMenu').style.display='block';document.getElementById('userDisplayName').innerText=currentUser.name;if(currentUser.role==='admin'){document.getElementById('adminArea').style.display='block';loadPendingUsers();}else{document.getElementById('adminArea').style.display='none';initFilters();}alert(`Xin ch√†o ${currentUser.name}!`);}
        function doLogout(){currentUser=null;location.reload();}
        async function loadPendingUsers(){const res = await callAPI({action:"getPendingUsers"}); let h='';if(res.length==0)h='<tr><td colspan="4" class="text-center">Tr·ªëng.</td></tr>';else{document.getElementById('badgePending').innerText=res.length;res.forEach(u=>{h+=`<tr><td>${u.grade}</td><td>${u.className}</td><td>${u.name}</td><td><button class="btn btn-sm btn-success" onclick="approveUser(${u.rowIndex})">Duy·ªát</button></td></tr>`});}document.getElementById('pendingTable').innerHTML=h;}
        async function approveUser(i){if(!confirm("Duy·ªát?"))return;toggleLoader(true);await callAPI({action:"approveUser",rowIndex:i});toggleLoader(false);loadPendingUsers();fetchData();}
        function doSaveVideo(){let t=document.getElementById('vidTitle').value,u=document.getElementById('vidUrl').value;if(!t||!u)return alert("Thi·∫øu th√¥ng tin");toggleLoader(true);callAPI({action:"saveVideo",title:t,url:u,grade:document.getElementById('vidGrade').value,category:document.getElementById('vidCat').value}).then(()=>{alert("Xong!");toggleLoader(false);fetchData();})}
        async function doChangePass(){let o=document.getElementById('oldP').value,n=document.getElementById('newP').value;if(!currentUser||!o||!n)return;toggleLoader(true);const r=await callAPI({action:"changePass",grade:currentUser.grade,className:currentUser.className,name:currentUser.name,oldPass:o,newPass:n});toggleLoader(false);alert(r.status=="success"?"ƒê·ªïi pass th√†nh c√¥ng":r.message);}
        function toggleLoader(b){document.getElementById('loader').style.display=b?'block':'none'}
        function textSearch(v){let k=v.toLowerCase();let s=currentMode==='hoclieu'?appData.files:appData.videos;let r=s.filter(i=>i.name.toLowerCase().includes(k));/*Simplified render*/}
        function initRegDropdowns(){let gs=Object.keys(appData.classes).sort((a,b)=>a-b);let h='<option value="">-- Ch·ªçn Kh·ªëi --</option>';gs.forEach(g=>h+=`<option value="${g}">Kh·ªëi ${g}</option>`);document.getElementById('regGrade').innerHTML=h;}
        function loadRegClasses(){let g=document.getElementById('regGrade').value,h='';if(g&&appData.classes[g])appData.classes[g].forEach(c=>h+=`<option value="${c}">${c}</option>`);document.getElementById('regClass').innerHTML=h;}
        async function doRegister(){let g=document.getElementById('regGrade').value,c=document.getElementById('regClass').value,n=document.getElementById('regName').value,p=document.getElementById('regPass').value;if(!g||!c||!n||!p)return alert("Thi·∫øu th√¥ng tin");toggleLoader(true);const r=await callAPI({action:"register",grade:g,className:c,name:n,pass:p});toggleLoader(false);if(r.status=="success"){alert("ƒêƒÉng k√Ω th√†nh c√¥ng! Ch·ªù duy·ªát.");modalLogin.hide();}else alert(r.message);}
        function initAdminDropdowns(){let h='';GRADE_CONFIG.forEach(g=>h+=`<option value="${g.id}">${g.name}</option>`);document.getElementById('upGrade').innerHTML=h;document.getElementById('vidGrade').innerHTML=h;document.getElementById('upGrade').dispatchEvent(new Event('change'));}
        document.getElementById('upGrade').addEventListener('change',function(){let g=this.value,c=(g=='ts10'||g=='thptqg')?SUB_CATS.hoclieu.special:SUB_CATS.hoclieu.default;document.getElementById('upCat').innerHTML=c.map(x=>`<option value="${x}">${x}</option>`).join('');});
    </script>
</body>
</html>
