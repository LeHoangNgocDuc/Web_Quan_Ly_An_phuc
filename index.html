<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng T√†i Li·ªáu An Ph√∫c</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        /* --- C·∫§U H√åNH GIAO DI·ªÜN --- */
        :root { --primary: #2c3e50; --accent: #d9534f; --light-bg: #f8f9fa; }
        body { background: var(--light-bg); font-family: 'Segoe UI', sans-serif; min-height: 100vh; }
        
        /* Navbar */
        .navbar-custom { background: #222; padding: 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .navbar-custom .nav-link { color: #aaa !important; padding: 15px 20px; font-weight: 500; text-transform: uppercase; font-size: 0.9rem; cursor: pointer; transition: 0.3s; }
        .navbar-custom .nav-link:hover { color: #fff !important; background: #333; }
        .navbar-custom .nav-link.active-tab { color: #fff !important; background: var(--accent); }
        .navbar-brand img { height: 45px; margin-right: 10px; border-radius: 4px; }
        
        /* B·ªô l·ªçc (Tabs) */
        .grade-btn { border: 1px solid #ddd; background: white; color: #555; border-radius: 20px; padding: 6px 18px; margin-right: 6px; font-weight: 500; white-space: nowrap; margin-bottom: 8px; transition: 0.2s; }
        .grade-btn:hover, .grade-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .grade-btn.special-access { border-color: #ffc107; background-color: #fff3cd; color: #856404; }
        
        .sub-btn { font-size: 0.85rem; padding: 4px 12px; border-radius: 4px; border: 1px dashed #aaa; color: #666; background: transparent; margin-right: 5px; margin-bottom: 5px; transition: 0.2s; }
        .sub-btn:hover, .sub-btn.active { background: var(--accent); color: white; border-style: solid; border-color: var(--accent); }

        /* Card T√†i li·ªáu */
        .item-card { background: #fff; border: 1px solid #e9ecef; padding: 15px; margin-bottom: 15px; border-radius: 8px; transition: 0.2s; display: flex; flex-direction: column; position: relative; overflow: hidden; }
        .item-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-color: var(--accent); }
        
        /* Admin Panel */
        #adminArea { display: none; background: #fff; border: 2px dashed #333; border-radius: 10px; padding: 20px; margin-bottom: 30px; }
        .nav-pills .nav-link.active { background-color: var(--accent) !important; }
        
        /* Loader */
        #loader { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.85); z-index:9999; text-align:center; padding-top:20vh; backdrop-filter: blur(2px); }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p class="mt-3 fw-bold text-secondary">ƒêang x·ª≠ l√Ω d·ªØ li·ªáu...</p>
        <small class="text-muted">Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t</small>
    </div>

    <nav class="navbar navbar-expand-lg navbar-custom sticky-top">
        <div class="container">
            <a class="navbar-brand text-white d-flex align-items-center" href="#">
                <img id="appLogo" src="" alt="Logo" onerror="this.style.display='none'"> 
                <span id="appName" class="fw-bold">AN PH√öC EDU</span>
            </a>
            
            <button class="navbar-toggler bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link active-tab" onclick="switchMainTab('hoclieu')" id="tab-hoclieu"><i class="bi bi-book"></i> H·ªåC LI·ªÜU</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="switchMainTab('elearning')" id="tab-elearning"><i class="bi bi-youtube"></i> ELEARNING</a></li>
                    <li class="nav-item"><a class="nav-link" href="https://web-dung-hinh.vercel.app/" target="_blank">WEB V·∫º H√åNH</a></li>
                    <li class="nav-item"><a class="nav-link" href="https://trung-tam-an-phuc.vercel.app/" target="_blank">KI·ªÇM TRA ONLINE</a></li>
                </ul>
                <div class="d-flex align-items-center mt-2 mt-lg-0">
                    <button class="btn btn-outline-light btn-sm rounded-pill px-3" onclick="modalLogin.show()" id="btnAuth">
                        <i class="bi bi-person-circle"></i> ƒêƒÇNG NH·∫¨P
                    </button>
                    <div id="userMenu" class="dropdown ms-2" style="display:none;">
                        <button class="btn btn-light btn-sm dropdown-toggle rounded-pill px-3" type="button" data-bs-toggle="dropdown" id="userDisplayName">
                           User
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end shadow">
                            <li><a class="dropdown-item" href="#" onclick="modalChangePass.show()"><i class="bi bi-key"></i> ƒê·ªïi m·∫≠t kh·∫©u</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="doLogout()"><i class="bi bi-box-arrow-right"></i> ƒêƒÉng xu·∫•t</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4 mb-5">
        
        <div id="adminArea">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="text-danger fw-bold m-0"><i class="bi bi-shield-lock-fill"></i> QU·∫¢N TR·ªä VI√äN</h5>
                <span class="badge bg-secondary">Mode: Admin</span>
            </div>
            
            <ul class="nav nav-pills mb-3 border-bottom pb-2">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-file">1. Upload T√†i Li·ªáu</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-video">2. ƒêƒÉng Video</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-approve" onclick="loadPendingUsers()">3. Duy·ªát th√†nh vi√™n <span class="badge bg-danger rounded-pill" id="badgePending"></span></button></li>
            </ul>
            
            <div class="tab-content">
                <div class="tab-pane fade show active" id="pills-file">
                    <div class="card p-4 bg-light border-0">
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="fw-bold small mb-1">Ch·ªçn Kh·ªëi L·ªõp:</label>
                                <select id="upGrade" class="form-select"></select>
                            </div>
                            <div class="col-md-6">
                                <label class="fw-bold small mb-1">Ch·ªçn M·ª•c:</label>
                                <select id="upCat" class="form-select"></select>
                            </div>
                        </div>

                        <div class="d-flex gap-4 mb-3 border p-2 bg-white rounded">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="uploadMode" id="modeFile" checked onchange="toggleUploadMode()">
                                <label class="form-check-label fw-bold" for="modeFile"><i class="bi bi-upload"></i> Upload File PDF (T·ª´ m√°y)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="uploadMode" id="modeLink" onchange="toggleUploadMode()">
                                <label class="form-check-label fw-bold" for="modeLink"><i class="bi bi-link-45deg"></i> Nh·∫≠p Link (File n·∫∑ng)</label>
                            </div>
                        </div>

                        <div id="areaFile">
                            <div class="input-group">
                                <input type="file" id="fileInput" class="form-control" accept=".pdf,.doc,.docx">
                                <button class="btn btn-danger" onclick="doUploadFile()"><i class="bi bi-cloud-arrow-up"></i> Upload Ngay</button>
                            </div>
                            <div class="form-text">* H·ªó tr·ª£ file PDF, Word. T·ªëi ƒëa 50MB.</div>
                        </div>

                        <div id="areaLink" style="display:none;">
                            <input type="text" id="linkName" class="form-control mb-2" placeholder="Nh·∫≠p t√™n t√†i li·ªáu hi·ªÉn th·ªã (V√≠ d·ª•: ƒê·ªÅ c∆∞∆°ng To√°n 9 HK2 - B·∫£n Full)">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-link"></i></span>
                                <input type="text" id="linkUrl" class="form-control" placeholder="D√°n link Google Drive ho·∫∑c Web v√†o ƒë√¢y">
                                <button class="btn btn-primary" onclick="doSaveLink()">L∆∞u Link</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="pills-video">
                    <div class="row g-2">
                        <div class="col-md-3"><select id="vidGrade" class="form-select"></select></div>
                        <div class="col-md-3"><select id="vidCat" class="form-select"><option>ƒê·∫°i s·ªë</option><option>H√¨nh h·ªçc</option></select></div>
                        <div class="col-md-6"><input type="text" id="vidTitle" class="form-control" placeholder="Ti√™u ƒë·ªÅ b√†i gi·∫£ng"></div>
                        <div class="col-md-12 mt-2">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-youtube text-danger"></i></span>
                                <input type="text" id="vidUrl" class="form-control" placeholder="D√°n link Youtube v√†o ƒë√¢y">
                                <button class="btn btn-danger" onclick="doSaveVideo()">ƒêƒÉng Video</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="pills-approve">
                    <div class="card p-3 mb-3 border-primary bg-light">
                        <h6 class="text-primary fw-bold"><i class="bi bi-file-earmark-spreadsheet"></i> Th√™m nhanh h·ªçc sinh t·ª´ Excel</h6>
                        <div class="row align-items-center g-2">
                            <div class="col-md-3">
                                <button class="btn btn-outline-secondary btn-sm w-100" onclick="downloadTemplate()"><i class="bi bi-download"></i> T·∫£i file m·∫´u CSV</button>
                            </div>
                            <div class="col-md-6">
                                <input type="file" id="csvFileInput" class="form-control form-control-sm" accept=".csv, .xlsx">
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-primary btn-sm w-100" onclick="handleBulkImport()"><i class="bi bi-check-circle"></i> Upload & Duy·ªát</button>
                            </div>
                        </div>
                        <div class="form-text small text-danger">* L∆∞u √Ω: File Excel ph·∫£i ch·ªçn <b>Save As -> CSV UTF-8 (Comma delimited)</b> ƒë·ªÉ kh√¥ng l·ªói ph√¥ng ch·ªØ.</div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover bg-white mb-0">
                            <thead class="table-light"><tr><th>Kh·ªëi</th><th>L·ªõp</th><th>H·ªç T√™n</th><th>H√†nh ƒë·ªông</th></tr></thead>
                            <tbody id="pendingTable"><tr><td colspan="4" class="text-center py-3">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="mb-4">
            <div class="d-flex align-items-center mb-3">
                <h4 class="fw-bold text-dark m-0 me-3" id="sectionTitle"><i class="bi bi-folder2-open text-danger"></i> KHO T√ÄI LI·ªÜU</h4>
                <div class="flex-grow-1 border-bottom"></div>
            </div>
            
            <div class="d-flex flex-wrap" id="gradeFilters" style="gap:5px;"></div>
            <div class="d-flex flex-wrap mt-2 p-2 bg-white rounded border" id="subFilters" style="display:none; gap:8px;"></div>
            
            <div class="mt-3 position-relative">
                <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
                <input type="text" class="form-control ps-5 rounded-pill" placeholder="T√¨m ki·∫øm b√†i h·ªçc, t√†i li·ªáu..." onkeyup="textSearch(this.value)">
            </div>
        </div>

        <div id="listContainer" class="row g-3">
            <div class="text-center py-5 text-muted">
                <div class="spinner-border text-secondary" role="status"></div>
                <p class="mt-2">ƒêang k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß...</p>
            </div>
        </div>
    </div>

    <div class="modal fade" id="loginModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title"><i class="bi bi-shield-lock"></i> H·ªá th·ªëng ƒêƒÉng nh·∫≠p</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <ul class="nav nav-tabs nav-fill mb-3">
                        <li class="nav-item"><button class="nav-link active fw-bold" data-bs-toggle="tab" data-bs-target="#tab-login">ƒêƒÇNG NH·∫¨P</button></li>
                        <li class="nav-item"><button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#tab-register">ƒêƒÇNG K√ù</button></li>
                    </ul>
                    
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="tab-login">
                            <div class="alert alert-light border small text-center mb-3">H·ªçc sinh vui l√≤ng ch·ªçn th√¥ng tin ƒë·ªÉ ƒëƒÉng nh·∫≠p.</div>
                            
                            <div class="mb-3">
                                <select id="logGrade" class="form-select mb-2 py-2" onchange="loadLogClasses()">
                                    <option value="">-- Ch·ªçn Kh·ªëi --</option>
                                </select>
                                <select id="logClass" class="form-select mb-2 py-2" onchange="loadLogNames()">
                                    <option value="">-- Ch·ªçn L·ªõp --</option>
                                </select>
                                <select id="logName" class="form-select mb-2 py-2">
                                    <option value="">-- Ch·ªçn T√™n H·ªçc Sinh --</option>
                                </select>
                            </div>
                            
                            <div class="input-group mb-4">
                                <span class="input-group-text"><i class="bi bi-key"></i></span>
                                <input type="password" id="logPass" class="form-control" placeholder="M·∫≠t kh·∫©u (M·∫∑c ƒë·ªãnh: 12345@)">
                            </div>
                            
                            <button class="btn btn-success w-100 fw-bold py-2 mb-3" onclick="doLogin()">ƒêƒÇNG NH·∫¨P H·ªåC SINH</button>
                            
                            <div class="accordion" id="accordionAdmin">
                                <div class="accordion-item border-0">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed py-2 bg-light text-muted small" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAdmin">
                                            <i class="bi bi-person-badge-fill me-2"></i> D√†nh cho Gi√°o vi√™n (Admin)
                                        </button>
                                    </h2>
                                    <div id="collapseAdmin" class="accordion-collapse collapse" data-bs-parent="#accordionAdmin">
                                        <div class="accordion-body bg-light">
                                            <input type="text" id="adminUser" class="form-control mb-2" placeholder="T√™n ƒëƒÉng nh·∫≠p">
                                            <input type="password" id="adminPass" class="form-control mb-2" placeholder="M·∫≠t kh·∫©u Admin">
                                            <button class="btn btn-dark w-100 btn-sm" onclick="doLogin()">ƒêƒÉng nh·∫≠p Admin</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="tab-register">
                             <div class="mb-3">
                                 <label class="form-label small fw-bold">Th√¥ng tin l·ªõp h·ªçc:</label>
                                 <div class="row g-2">
                                     <div class="col-4"><select id="regGrade" class="form-select" onchange="loadRegClasses()"></select></div>
                                     <div class="col-8"><select id="regClass" class="form-select"></select></div>
                                 </div>
                             </div>
                             <div class="mb-3">
                                 <label class="form-label small fw-bold">H·ªç v√† t√™n:</label>
                                 <input type="text" id="regName" class="form-control" placeholder="Nh·∫≠p h·ªç t√™n ƒë·∫ßy ƒë·ªß (C√≥ d·∫•u)">
                             </div>
                             <div class="mb-4">
                                 <label class="form-label small fw-bold">M·∫≠t kh·∫©u t·ª± t·∫°o:</label>
                                 <input type="password" id="regPass" class="form-control" placeholder="Nh·∫≠p m·∫≠t kh·∫©u">
                             </div>
                             <button class="btn btn-primary w-100 fw-bold py-2" onclick="doRegister()">G·ª¨I Y√äU C·∫¶U ƒêƒÇNG K√ù</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="changePassModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title fs-6">ƒê·ªïi m·∫≠t kh·∫©u</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="password" id="oldP" class="form-control mb-2" placeholder="M·∫≠t kh·∫©u c≈©">
                    <input type="password" id="newP" class="form-control" placeholder="M·∫≠t kh·∫©u m·ªõi">
                </div>
                <div class="modal-footer"><button class="btn btn-primary w-100" onclick="doChangePass()">L∆∞u thay ƒë·ªïi</button></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // =========================================================================
        // 1. C·∫§U H√åNH H·ªÜ TH·ªêNG
        // =========================================================================
        
        // D√ÅN LINK WEB APP C·ª¶A TH·∫¶Y V√ÄO ƒê√ÇY (Link c√≥ ƒëu√¥i /exec):
        const API_URL = "https://script.google.com/macros/s/AKfycbzZN010AXmAthc-KX527ycL5AQZnDcWSBPIFUO8jzoZzz-Ygc0Ps5KTwSKdTybiR_JBpA/exec"; 
        
        // Link Logo (Thay link ·∫£nh c·ªßa th·∫ßy v√†o ƒë√¢y)
        const LOGO_URL = "https://raw.githubusercontent.com/lehoangngocduc/Hoc-Toan-An-Phuc/main/logo.png"; 
        
        // =========================================================================

        const GRADE_CONFIG = [{id:"6",name:"L·ªõp 6"},{id:"7",name:"L·ªõp 7"},{id:"8",name:"L·ªõp 8"},{id:"9",name:"L·ªõp 9"},{id:"ts10",name:"TS10"},{id:"10",name:"L·ªõp 10"},{id:"11",name:"L·ªõp 11"},{id:"12",name:"L·ªõp 12"},{id:"thptqg",name:"THPTQG"}];
        const SUB_CATS = { hoclieu:{default:["HKI","HKII","L√Ω thuy·∫øt"],special:["Chuy√™n ƒë·ªÅ"]}, elearning:{default:["ƒê·∫°i s·ªë","H√¨nh h·ªçc"],special:["ƒê·∫°i s·ªë","H√¨nh h·ªçc"]} };
        
        let appData = {files:[],videos:[],classes:{},users:{}};
        let currentMode = 'hoclieu'; 
        let currentFilter = {grade:'all',category:'all'}; 
        let currentUser = null;

        const modalLogin = new bootstrap.Modal(document.getElementById('loginModal'));
        const modalChangePass = new bootstrap.Modal(document.getElementById('changePassModal'));

        // KHI TRANG T·∫¢I XONG
        window.onload = function() {
            if(LOGO_URL && LOGO_URL.startsWith("http")) { 
                document.getElementById('appLogo').src = LOGO_URL; 
                document.getElementById('appLogo').style.display = 'block';
            }
            if(!API_URL.includes("script.google.com")){ 
                alert("C·∫¢NH B√ÅO: Th·∫ßy ch∆∞a d√°n Link API v√†o d√≤ng 252!"); 
                return; 
            }
            initFilters(); 
            fetchData(); 
        };

        // --- H√ÄM G·ªåI API (QUAN TR·ªåNG: TEXT/PLAIN ƒê·ªÇ TR√ÅNH CORS) ---
        async function callAPI(payload) {
            try {
                const res = await fetch(API_URL, {
                    method: "POST",
                    // Trick: D√πng text/plain ƒë·ªÉ tr√¨nh duy·ªát kh√¥ng g·ª≠i Preflight request (OPTIONS)
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify(payload)
                });
                return await res.json();
            } catch (error) {
                console.error("API Error:", error);
                return { status: "error", message: "Kh√¥ng th·ªÉ k·∫øt n·ªëi Server! Vui l√≤ng th·ª≠ l·∫°i sau." };
            }
        }
        
        async function fetchData() {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                
                if(data.error) { 
                    alert("L·ªói Server Backend: " + data.error); 
                    return; 
                }
                
                appData = data;
                applyFilter(); 
                initLogDropdowns(); 
                initRegDropdowns(); 
                initAdminDropdowns();
            } catch (e) { console.error(e); }
        }

        // --- LOGIC GIAO DI·ªÜN (UI) ---
        function switchMainTab(mode) {
            currentMode = mode;
            currentFilter = {grade:'all',category:'all'};
            // ƒê·ªïi active tab
            document.querySelectorAll('.navbar-custom .nav-link').forEach(l => l.classList.remove('active-tab'));
            document.getElementById('tab-' + mode).classList.add('active-tab');
            // ƒê·ªïi ti√™u ƒë·ªÅ
            document.getElementById('sectionTitle').innerHTML = mode === 'hoclieu' 
                ? '<i class="bi bi-folder2-open text-danger"></i> KHO T√ÄI LI·ªÜU' 
                : '<i class="bi bi-youtube text-danger"></i> KHO VIDEO ELEARNING';
            
            initFilters();
            applyFilter();
        }

        function initFilters() {
            const container = document.getElementById('gradeFilters');
            let html = `<button class="grade-btn active" onclick="filterGrade('all',this)">T·∫•t c·∫£</button>`;
            
            GRADE_CONFIG.forEach(g => {
                let extraClass = "";
                // Highlight l·ªõp c·ªßa h·ªçc sinh n·∫øu ƒë√£ ƒëƒÉng nh·∫≠p
                if(currentUser) {
                    if(currentUser.grade == "9" && g.id == "ts10") extraClass = "special-access";
                    if(currentUser.grade == "12" && g.id == "thptqg") extraClass = "special-access";
                    if(currentUser.grade == g.id) extraClass = "active"; // Auto active l·ªõp HS
                }
                html += `<button class="grade-btn ${extraClass}" onclick="filterGrade('${g.id}',this)">${g.name}</button>`;
            });
            container.innerHTML = html;
        }

        function filterGrade(gradeId, btnElement) {
            document.querySelectorAll('.grade-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');
            
            currentFilter.grade = gradeId;
            currentFilter.category = 'all';

            // Render Sub-filters
            const subContainer = document.getElementById('subFilters');
            if(gradeId === 'all') {
                subContainer.style.display = 'none';
            } else {
                subContainer.style.display = 'flex';
                let cats = (gradeId === 'ts10' || gradeId === 'thptqg') 
                           ? SUB_CATS[currentMode].special 
                           : SUB_CATS[currentMode].default;
                
                let html = `<button class="sub-btn active" onclick="filterSub('all',this)">T·∫•t c·∫£</button>`;
                cats.forEach(c => {
                    html += `<button class="sub-btn" onclick="filterSub('${c}',this)">${c}</button>`;
                });
                subContainer.innerHTML = html;
            }
            applyFilter();
        }

        function filterSub(cat, btn) {
            document.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentFilter.category = cat;
            applyFilter();
        }

        function applyFilter() {
            const container = document.getElementById('listContainer');
            let source = currentMode === 'hoclieu' ? appData.files : appData.videos;
            
            let result = source.filter(item => {
                let matchGrade = currentFilter.grade === 'all' || item.grade == currentFilter.grade;
                let matchCat = currentFilter.category === 'all' || item.category == currentFilter.category;
                return matchGrade && matchCat;
            });

            if(result.length === 0) {
                container.innerHTML = '<div class="col-12 text-center text-muted py-5"><i class="bi bi-inbox fs-1"></i><p>Ch∆∞a c√≥ n·ªôi dung ·ªü m·ª•c n√†y.</p></div>';
                return;
            }

            let html = '';
            result.forEach(item => {
                let gradeName = GRADE_CONFIG.find(g => g.id == item.grade)?.name || "Chung";
                
                if(item.type === 'file') {
                    // FILE CARD
                    let icon = 'bi-file-earmark-pdf-fill';
                    let btnText = (item.source === 'link') ? 'üîó M·ªü Link' : '‚¨á T·∫£i v·ªÅ';
                    let badgeColor = (item.source === 'link') ? 'bg-info' : 'bg-secondary';
                    
                    html += `
                    <div class="col-md-6 col-lg-4">
                        <div class="item-card flex-row align-items-center h-100">
                            <i class="bi ${icon} text-danger fs-1 me-3 ps-2"></i>
                            <div class="flex-grow-1">
                                <h6 class="fw-bold mb-1 text-truncate-2" title="${item.name}">${item.name}</h6>
                                <div class="small text-muted mb-2">
                                    <span class="badge ${badgeColor}">${item.category}</span> ${gradeName}
                                </div>
                                <a href="${item.url}" target="_blank" class="btn btn-sm btn-outline-primary rounded-pill px-3">${btnText}</a>
                            </div>
                        </div>
                    </div>`;
                } else {
                    // VIDEO CARD
                    let vidId = item.url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/)?.[2] || "";
                    let thumb = `https://img.youtube.com/vi/${vidId}/mqdefault.jpg`;
                    
                    html += `
                    <div class="col-md-6 col-lg-4">
                        <div class="item-card p-0">
                            <a href="${item.url}" target="_blank" class="position-relative">
                                <img src="${thumb}" style="width:100%; height:180px; object-fit:cover;">
                                <div class="position-absolute top-50 start-50 translate-middle">
                                    <i class="bi bi-play-circle-fill text-danger fs-1 bg-white rounded-circle"></i>
                                </div>
                            </a>
                            <div class="p-3">
                                <h6 class="fw-bold text-truncate mb-1">${item.name}</h6>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge bg-success">${item.category}</span>
                                    <small class="text-muted">${gradeName}</small>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }
            });
            container.innerHTML = html;
        }

        // --- UPLOAD & IMPORT HANDLERS ---
        function toggleUploadMode() {
            let isFile = document.getElementById('modeFile').checked;
            document.getElementById('areaFile').style.display = isFile ? 'block' : 'none';
            document.getElementById('areaLink').style.display = isFile ? 'none' : 'block';
        }

        // Upload File PDF
        function doUploadFile() {
            let f = document.getElementById('fileInput').files[0];
            if(!f) return alert("Ch∆∞a ch·ªçn file!");
            if(f.size > 50 * 1024 * 1024) return alert("File > 50MB. Vui l√≤ng d√πng ch·∫ø ƒë·ªô 'Nh·∫≠p Link'!");

            toggleLoader(true);
            let r = new FileReader();
            r.readAsDataURL(f);
            r.onload = async function() {
                const res = await callAPI({
                    action: "upload", 
                    fileName: f.name, mimeType: f.type, fileData: r.result.split(',')[1],
                    grade: document.getElementById('upGrade').value, 
                    category: document.getElementById('upCat').value
                });
                toggleLoader(false);
                if(res.status === "success") { alert("Upload th√†nh c√¥ng!"); fetchData(); } 
                else alert("L·ªói: " + res.message);
            };
        }

        // Upload Link
        async function doSaveLink() {
            let n = document.getElementById('linkName').value;
            let u = document.getElementById('linkUrl').value;
            if(!n || !u) return alert("Vui l√≤ng nh·∫≠p t√™n t√†i li·ªáu v√† link!");
            
            toggleLoader(true);
            const res = await callAPI({
                action: "saveFileLink", fileName: n, url: u,
                grade: document.getElementById('upGrade').value, category: document.getElementById('upCat').value
            });
            toggleLoader(false);
            if(res.status === "success") { 
                alert("L∆∞u Link th√†nh c√¥ng!"); 
                document.getElementById('linkName').value=''; 
                document.getElementById('linkUrl').value='';
                fetchData(); 
            } else alert("L·ªói: " + res.message);
        }

        // Import CSV (Fix l·ªói font)
        function handleBulkImport() {
            const f = document.getElementById('csvFileInput').files[0];
            if(!f) return alert("Ch∆∞a ch·ªçn file CSV!");
            
            let r = new FileReader();
            r.onload = async function(e) {
                toggleLoader(true);
                const res = await callAPI({ action: "importUsersBulk", csvContent: e.target.result });
                toggleLoader(false);
                if(res.status === "success") { 
                    alert("ƒê√£ th√™m th√†nh c√¥ng " + res.count + " h·ªçc sinh!"); 
                    document.getElementById('csvFileInput').value = '';
                    fetchData(); 
                } else alert("L·ªói: " + res.message);
            };
            // ƒê·ªçc file v·ªõi encoding UTF-8 ƒë·ªÉ kh√¥ng l·ªói ti·∫øng Vi·ªát
            r.readAsText(f, "UTF-8");
        }

        // --- AUTH DROPDOWNS ---
        function initLogDropdowns(){
            if(!appData.users) return;
            // Ch·ªâ l·∫•y nh·ªØng kh·ªëi c√≥ User Active
            let gs = Object.keys(appData.users).sort((a,b)=>a-b);
            let h = '<option value="">-- Ch·ªçn Kh·ªëi --</option>';
            gs.forEach(g => h += `<option value="${g}">Kh·ªëi ${g}</option>`);
            document.getElementById('logGrade').innerHTML = h;
        }
        function loadLogClasses(){
            let g = document.getElementById('logGrade').value;
            let h = '<option value="">-- Ch·ªçn L·ªõp --</option>';
            if(g && appData.users[g]) Object.keys(appData.users[g]).sort().forEach(c => h += `<option value="${c}">${c}</option>`);
            document.getElementById('logClass').innerHTML = h;
            document.getElementById('logName').innerHTML = '<option value="">-- Ch·ªçn T√™n H·ªçc Sinh --</option>';
        }
        function loadLogNames(){
            let g = document.getElementById('logGrade').value, c = document.getElementById('logClass').value;
            let h = '<option value="">-- Ch·ªçn T√™n H·ªçc Sinh --</option>';
            if(g && c && appData.users[g][c]) appData.users[g][c].forEach(n => h += `<option value="${n}">${n}</option>`);
            document.getElementById('logName').innerHTML = h;
        }

        // --- AUTH ACTIONS ---
        async function doLogin() {
            let u = document.getElementById('adminUser').value;
            let p = document.getElementById('adminPass').value;
            
            // 1. Check Admin Login
            if(u || p) {
                toggleLoader(true);
                const res = await callAPI({action:"login", username:u, pass:p});
                toggleLoader(false);
                if(res.status=="success" && res.role=="admin") {
                    currentUser = res; 
                    onLoginSuccess();
                } else alert("Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u Admin!");
            } else {
                // 2. Check Student Login
                let n = document.getElementById('logName').value;
                let lp = document.getElementById('logPass').value;
                if(!n) return alert("Vui l√≤ng ch·ªçn t√™n h·ªçc sinh!");
                if(!lp) lp = "12345@"; // Auto fill n·∫øu ƒë·ªÉ tr·ªëng (t√πy ch·ªçn)

                toggleLoader(true);
                const res = await callAPI({action:"login", username:n, pass:lp});
                toggleLoader(false);
                if(res.status=="success") {
                    currentUser = res;
                    onLoginSuccess();
                } else alert(res.message);
            }
        }

        function onLoginSuccess() {
            modalLogin.hide();
            document.getElementById('btnAuth').parentElement.style.display = 'none'; // Hide login btn
            document.getElementById('userMenu').style.display = 'block';
            document.getElementById('userDisplayName').innerHTML = `<i class="bi bi-person-circle"></i> ${currentUser.name}`;
            
            if(currentUser.role === 'admin') {
                document.getElementById('adminArea').style.display = 'block';
                loadPendingUsers();
            } else {
                document.getElementById('adminArea').style.display = 'none';
                initFilters(); // Re-init filters to highlight student's grade
            }
            alert(`Xin ch√†o ${currentUser.name}!`);
        }

        function doLogout() {
            currentUser = null;
            location.reload();
        }

        // --- OTHER UTILS ---
        function initRegDropdowns(){
            if(!appData.classes) return;
            let gs = Object.keys(appData.classes).sort((a,b)=>a-b);
            let h = '<option value="">-- Ch·ªçn Kh·ªëi --</option>';
            gs.forEach(g => h += `<option value="${g}">Kh·ªëi ${g}</option>`);
            document.getElementById('regGrade').innerHTML = h;
        }
        function loadRegClasses(){
            let g = document.getElementById('regGrade').value, h = '';
            if(g && appData.classes[g]) appData.classes[g].forEach(c => h += `<option value="${c}">${c}</option>`);
            document.getElementById('regClass').innerHTML = h;
        }
        async function doRegister(){
            let g = document.getElementById('regGrade').value, c = document.getElementById('regClass').value, n = document.getElementById('regName').value, p = document.getElementById('regPass').value;
            if(!g || !c || !n || !p) return alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!");
            toggleLoader(true);
            const res = await callAPI({action:"register", grade:g, className:c, name:n, pass:p});
            toggleLoader(false);
            if(res.status=="success"){ alert("ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ch·ªù th·∫ßy duy·ªát."); modalLogin.hide(); } else alert(res.message);
        }
        async function loadPendingUsers(){
            const res = await callAPI({action:"getPendingUsers"}); 
            let h = '';
            if(!res || res.length==0) h='<tr><td colspan="4" class="text-center py-3 text-muted">Kh√¥ng c√≥ y√™u c·∫ßu n√†o c·∫ßn duy·ªát.</td></tr>';
            else {
                document.getElementById('badgePending').innerText = res.length;
                res.forEach(u => {
                    h += `<tr><td>${u.grade}</td><td>${u.className}</td><td>${u.name}</td><td class="text-center"><button class="btn btn-sm btn-success" onclick="approveUser(${u.rowIndex})">Duy·ªát</button></td></tr>`;
                });
            }
            document.getElementById('pendingTable').innerHTML = h;
        }
        async function approveUser(i){
            if(!confirm("X√°c nh·∫≠n duy·ªát h·ªçc sinh n√†y?")) return;
            toggleLoader(true); await callAPI({action:"approveUser", rowIndex:i}); toggleLoader(false);
            loadPendingUsers(); fetchData();
        }
        function doSaveVideo(){
            let t=document.getElementById('vidTitle').value, u=document.getElementById('vidUrl').value;
            if(!t || !u) return alert("Thi·∫øu th√¥ng tin");
            toggleLoader(true);
            callAPI({
                action:"saveVideo", title:t, url:u, 
                grade:document.getElementById('vidGrade').value, category:document.getElementById('vidCat').value
            }).then(() => { alert("ƒêƒÉng video th√†nh c√¥ng!"); toggleLoader(false); fetchData(); });
        }
        async function doChangePass(){
            let o=document.getElementById('oldP').value, n=document.getElementById('newP').value;
            if(!currentUser || !o || !n) return;
            toggleLoader(true);
            const r = await callAPI({action:"changePass", grade:currentUser.grade, className:currentUser.className, name:currentUser.name, oldPass:o, newPass:n});
            toggleLoader(false);
            alert(r.status=="success" ? "ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!" : r.message);
        }
        function toggleLoader(b){ document.getElementById('loader').style.display = b ? 'block' : 'none'; }
        function downloadTemplate(){
            const c = "\ufeffKh·ªëi,L·ªõp,H·ªç v√† T√™n,M·∫≠t kh·∫©u(T√πy ch·ªçn)\n6,6A,Nguy·ªÖn VƒÉn A,12345@\n9,9A,Tr·∫ßn Th·ªã B,";
            const b = new Blob([c], {type: 'text/csv;charset=utf-8;'});
            const l = document.createElement("a"); l.href = URL.createObjectURL(b); l.download = "Mau_Danh_Sach_HS.csv"; l.click();
        }
        function textSearch(v){
            let k = v.toLowerCase();
            let source = currentMode === 'hoclieu' ? appData.files : appData.videos;
            let result = source.filter(i => i.name.toLowerCase().includes(k));
            // Simple re-render logic just for search results
            // (Note: This is a simplified search rendering)
            const container = document.getElementById('listContainer');
            if(result.length===0){ container.innerHTML='<div class="col-12 text-center text-muted">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£.</div>'; return; }
            let h=''; 
            result.forEach(i => { /* Reuse logic from applyFilter */ 
                 let gn=GRADE_CONFIG.find(g=>g.id==i.grade)?.name||"Chung";
                 if(i.type==='file'){
                     let linkMode = i.source==='link' ? 'üîó Link' : '‚¨á T·∫£i v·ªÅ';
                     h+=`<div class="col-md-6 col-lg-4"><div class="item-card flex-row align-items-center"><i class="bi bi-file-earmark-pdf-fill text-danger fs-1 me-3"></i><div><h6 class="fw-bold mb-1">${i.name}</h6><small class="text-muted">${gn}</small><br><a href="${i.url}" target="_blank" class="btn btn-sm btn-outline-primary mt-1">${linkMode}</a></div></div></div>`;
                 } else { h+=`<div class="col-md-6 col-lg-4"><div class="item-card p-3"><h6>${i.name}</h6><a href="${i.url}" target="_blank">Xem Video</a></div></div>`; }
            });
            container.innerHTML=h;
        }
        function initAdminDropdowns(){
            let h=''; GRADE_CONFIG.forEach(g => h+=`<option value="${g.id}">${g.name}</option>`);
            document.getElementById('upGrade').innerHTML=h;
            document.getElementById('vidGrade').innerHTML=h;
            document.getElementById('upGrade').dispatchEvent(new Event('change'));
        }
        document.getElementById('upGrade').addEventListener('change',function(){
            let g=this.value, c=(g=='ts10'||g=='thptqg') ? SUB_CATS.hoclieu.special : SUB_CATS.hoclieu.default;
            document.getElementById('upCat').innerHTML = c.map(x => `<option value="${x}">${x}</option>`).join('');
        });
    </script>
</body>
</html>
